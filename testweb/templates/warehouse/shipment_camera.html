{% extends "main.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Capture / Upload Images for Shipment: {{ shipment.suit_number }}</h2>

  <!-- File Upload -->
  <form id="fileUploadForm" enctype="multipart/form-data" method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="fileInput" class="form-label">Upload Image</label>
      <input type="file" name="image" id="fileInput" class="form-control" accept="image/*">
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
  </form>

  <hr>

  <!-- Camera Capture -->
  <h4>Capture from Camera</h4>
  <video id="camera" autoplay playsinline class="border" width="400"></video>
  <canvas id="canvas" class="d-none"></canvas>
  <br>
  <button id="captureBtn" class="btn btn-success mt-2">Capture</button>

  <div id="preview" class="mt-3"></div>

  <hr>
  <h4>Uploaded Images</h4>
  <div id="imagesList" class="row"></div>
</div>

<script>
  const suitNumber = "{{ shipment.suit_number }}";
  const csrfToken = "{{ csrf_token }}";

  // ----- File Upload -----
  document.getElementById("fileUploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch(`/warehouse/shipment/${suitNumber}/upload/`, {
      method: "POST",
      headers: {"X-CSRFToken": csrfToken},
      body: formData
    });
    if (res.ok) {
      loadImages();
      this.reset();
    }
  });

  // ----- Camera Setup -----
  const video = document.getElementById("camera");
  const canvas = document.getElementById("canvas");
  const captureBtn = document.getElementById("captureBtn");

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  captureBtn.addEventListener("click", () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/jpeg");

    fetch(`/warehouse/shipment/${suitNumber}/upload_base64/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken
      },
      body: `image_data=${encodeURIComponent(dataUrl)}`
    }).then(res => {
      if (res.ok) loadImages();
    });
  });

  // ----- Load Images -----
  async function loadImages() {
    const res = await fetch(`/warehouse/shipment/${suitNumber}/images/`);
    const data = await res.json();
    const container = document.getElementById("imagesList");
    container.innerHTML = "";
    data.images.forEach(img => {
      const col = document.createElement("div");
      col.className = "col-md-3 mb-3";
      col.innerHTML = `
        <div class="card">
          <img src="${img.url}" class="card-img-top" />
          <div class="card-body">
            <small>${img.captured_at}</small>
          </div>
        </div>`;
      container.appendChild(col);
    });
  }

  // Initial load
  loadImages();
</script>
{% endblock %}
